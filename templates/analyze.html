{% extends 'base.html' %}

{% block title %}データ分析{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>データ分析</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {# 機械学習モデルによる予測フォームと結果表示エリア #}
    <div class="card mb-4">
        <div class="card-header">
            <h3>LM(2002)モデルに基づくG' / G'' 予測 (機械学習)</h3>
        </div>
        <div class="card-body">
            {% if ml_error %}
                <div class="alert alert-danger">
                    {{ get_flashed_messages(category_filter=['error'])[0] if get_flashed_messages(category_filter=['error']) else "機械学習モデルがロードされていません。管理者にお問い合わせください。" }}
                </div>
            {% else %}
                <form action="{{ url_for('analyze_data') }}" method="post" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="predict_z_value" class="form-label">Z 値:</label>
                        <input type="number" step="any" class="form-control" id="predict_z_value" name="predict_z_value" required value="{{ request.form.get('predict_z_value', '') }}">
                        <div class="invalid-feedback">
                            Z値を入力してください。
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="predict_omega_value" class="form-label">無次元化周波数 (ωτe):</label>
                        <input type="number" step="any" class="form-control" id="predict_omega_value" name="predict_omega_value" required value="{{ request.form.get('predict_omega_value', '') }}">
                        <div class="invalid-feedback">
                            無次元化周波数を入力してください。
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" name="predict_ml">予測実行</button>
                    {# hidden input は、もし複数のフォームがある場合に、どのボタンが押されたかを app.py 側で判別するために使われることがあるが、今回は predict_ml ボタンの name 属性で識別可能 #}
                </form>

                {% if prediction_results %}
                    <h4 class="mt-4">予測結果:</h4>
                    <p><strong>入力Z値:</strong> {{ prediction_results.input_z }}</p>
                    <p><strong>入力無次元化周波数 (ωτe):</strong> {{ prediction_results.input_omega }}</p>
                    <p><strong>予測 G' / Ge:</strong> {{ prediction_results.predicted_gp_over_ge }}</p>
                    <p><strong>予測 G'' / Ge:</strong> {{ prediction_results.predicted_gpp_over_ge }}</p>
                {% endif %}
            {% endif %}
        </div>
    </div>

    {# データベースからの実験データ結合・分析フォームと結果表示エリア #}
    <div class="card mt-4 mb-4">
        <div class="card-header">
            <h3>データベースからの実験データ結合・分析</h3>
        </div>
        <div class="card-body">
            <form action="{{ url_for('analyze_data') }}" method="post" class="needs-validation" novalidate>
                <div class="mb-3">
                    <label for="device_name" class="form-label">実験装置名:</label>
                    <input type="text" class="form-control" id="device_name" name="device_name" value="{{ request.form.get('device_name', '') }}">
                </div>
                <div class="mb-3">
                    <label for="sample_name" class="form-label">サンプル名:</label>
                    <input type="text" class="form-control" id="sample_name" name="sample_name" value="{{ request.form.get('sample_name', '') }}">
                </div>
                <button type="submit" class="btn btn-info" name="analyze_db">データ結合・分析</button>
            </form>
        </div>
    </div>

    {# 結合されたデータ概要の表示エリア #}
    {% if analysis_result %}
        <div class="card mt-4">
            <div class="card-header">
                <h3>結合されたデータ概要</h3>
            </div>
            <div class="card-body">
                <p>{{ analysis_result.message }}</p>
                {% if analysis_result.head %}
                    <h4>最初の5行:</h4>
                    {{ analysis_result.head | safe }}
                {% endif %}
                {% if analysis_result.description %}
                    <h4 class="mt-4">統計情報:</h4>
                    {{ analysis_result.description | safe }}
                {% endif %}
            </div>
        </div>
    {% endif %}

</div>
{% endblock %}